<html>
<head>
<title>Tinytask</title>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
<link rel="apple-touch-icon" ref="{{ url_for('static', filename='tinytask_logo.png') }}" />
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
<meta name="viewport" content="width=device-width, target-densityDpi=device-dpi, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  font-weight: normal;
  font-size: 18pt;
}
a {
  text-decoration: none;
  color: black;
}
line {
  stroke-linecap: round;
  stroke-width: 2px;
  stroke: black;
}
rect {
  fill: white;
}
svg {
  vertical-align: -3px;
  stroke: black;
}
.touchable:active {
  animation: darken .3s;
}
.twirling {
  animation-name: twirl;
  animation-duration: 0.8s;
  animation-iteration-count: 1;
}
@keyframes twirl {
  0% {
    transform: rotate(0deg);
    transform-origin: center center;
  }
  100% {
    transform: rotate(360deg);
    transform-origin: center center;
  }
}
@keyframes darken {
  0% {
    background-color: white;
    color: white;
    fill: white;
  }
  100% {
    background-color: lightsteelblue;
    color: lightsteelblue;
    fill: lightsteelblue;
  }
}

/* Date nav styling */
div#date_nav {
  margin-bottom: 22px;
  margin-top: -58px;
  height: 35px;
  width: 384px; 
  display: none;
  background: white;
  position: fixed;
}
div#date_nav_placeholder {
  margin-bottom: 22px;
  margin-top: 22px;
  height: 35px;
  width: 384px; 
}
g.future > line#date_backslash, g.future > line#date_forwardslash {
  stroke-width: 0px;
}
g.present > line#date_backslash {
  stroke-width: 0px;
}
g.past > line#date_backlash, g.past > line#date_forwardslash {
  stroke-width: 2px;
}

/* Date nav SVGs */
div.past {
  color: black;
}
div.past line, div.past rect {
  stroke: black;
}
div.present line#backslash, div.future line#backslash, div.future line#forwardslash {
  stroke-width: 0;
}

/* Task text and menu */
div#list_container {
  margin-left: 20px;
  margin-top: 80px;
}
div.task_container {
  padding-bottom: 10px;
  margin-right: 20px;
}
span.task_text {
  padding-left: 5px;
  line-height: 130%;
}
div.taskmenu {
  display: none;
  border-width: 2px 0px 0px 0px;
  border-style: solid;
  border-color: darkgray;
  background-color: rgb(245, 245, 245);
  padding-left: 65px;
  margin-left: -28px;
  margin-top: 5px;
  vertical-align: top;
}

/* Diamond styles */
svg.notdone line, svg.started > line#backslash {
  stroke-width: 0px;
}
svg.started > line#forwardslash {
  stroke-width: 2px;
}
svg.done + span.task_text {
  color: gray;
}
svg.done * {
  stroke: gray;
}

/* Entry form style */
input {
  font-family: sans-serif;
  font-weight: normal;
  font-size: 18pt;
}
#input_form {
  margin-left: 20px;
}
#entry_box {
  width: 300px;
  border: 0;
  outline: 0;
  background: transparent;
  border-bottom: 2px solid black;
  margin-left: 4px;
}

/* Logo stuff */
div.tt_logo {
  width: 120px;
  color: gray;
  margin-bottom: 10px;
  margin-left: 240px;
}
#logoslash {
  stroke: gray;
}
div.logomenu {
  display: none;
  text-align: right;
  width: 180px;
  border-width: 2px 0px 0px 0px;
  border-style: solid;
  border-color: darkgray;
  background-color: rgb(245, 245, 245);
  margin-right: 33px;
  margin-left: 220px;
  padding-right: 20px;
  vertical-align: top;
}
</style>

</head>

{% macro date_nav() %}
<div id="date_nav">
  <svg width="400" height="30">
    <g transform="translate(55,0)"> 
      <rect id="yesterday_button" class="touchable" width="70" height="30" x="-25" y="0" stroke="white" />
      <line x1="15" y1="1" x2="1" y2="15" />
      <line x1="15" y1="29" x2="1" y2="15" />
    </g>
    <g transform="translate(297,0)"> 
      <rect id="tomorrow_button" class="touchable" width="70" height="30" x="-15" y="0" stroke="white" />
      <line x1="15" y1="1" x2="29" y2="15" />
      <line x1="29" y1="15" x2="15" y2="29" />
    </g>
    <g id="date_display" transform="translate(125, 0)">
      <g id="date_diamond" class="future" transform="translate(0, 0)">
        <rect x="6" y="6" rx="1" ry="1" stroke-width="2px" width="18" height="18" transform="rotate(45 15 15)" />  
        <line id="date_forwardslash" x1="27" y1="3" x2="3" y2="27" />
        <line id="date_backslash" x1="3" y1="3" x2="27" y2="27" />
      </g>
      <text x="0" y="26" style="
        font-family: sans-serif;
        font-weight: normal;
        font-size: 22pt;
        stroke-width: 0px;
      " transform="translate(35,0)">{{ get_readable_date(date) }}</text>
    </g>
  </svg>
</div>

<div id="date_test_width" style="
    display: none; 
    font-family: sans-serif;
    font-weight: normal;
    font-size: 22pt;
  ">
  {{ get_readable_date(date) }}
</div>
{% endmacro %}

{% macro draw_task(task) %}
<div class="task_container" date="{{ date }}" key="{{ task['task_key'] }}">
  <svg id="task_diamond" class="{{ task['status'] }}" width="28" height="28">
    <g transform="translate(0) rotate(45 12 16)">
      <rect class="touchable" x="3" y="4" rx="1" ry="1" width="18" height="18" stroke-width="2px" />
    </g>
    <line id="forwardslash" x1="27" y1="1" x2="1" y2="27" />
    <line id="backslash" x1="1" y1="1" x2="27" y2="27" />
  </svg>
  <span class="task_text touchable">{{ task['description'] }}</span>
  <div class="taskmenu">
    <span class="touchable" id="un-do">{{ draw_undo() }}un-do</span><br>
    <span class="touchable" id="delete">{{ draw_delete() }}delete</span>
    <span class="touchable" id="move-tomorrow"><br>{{ draw_tomorrow() }}tomorrow</span>
  </div>
</div>
{% endmacro %}

{% macro draw_task_test(task) %}
<div class="task_container" date="{{ date }}" key="{{ task['task_key'] }}">
  <svg id="task_diamond" class="{{ task['status'] }}" width="28" height="28">
    <g transform="translate(0) rotate(45 12 16)">
      <rect class="touchable" x="3" y="4" rx="1" ry="1" width="18" height="18" stroke-width="2px" />
    </g>
    <line id="forwardslash" x1="27" y1="1" x2="1" y2="27" />
    <line id="backslash" x1="1" y1="1" x2="27" y2="27" />
  </svg>
  <span class="task_text touchable">{{ task['description'] }}</span>
  <div class="taskmenu">
    <span class="touchable" id="un-do">{{ draw_undo() }}un-do</span><br>
    <span class="touchable" id="delete">{{ draw_delete() }}delete</span>
    <span class="touchable" id="move-tomorrow"><br>{{ draw_tomorrow() }}tomorrow</span>
  </div>
</div>
{% endmacro %}

{% macro draw_undo() %}
<svg width="22" height="22" viewBox="0 0 22 22">
  <g transform="translate(0) rotate(45 15 10)">
    <rect x="6" y="6" rx="1" ry="1" width="14" height="14" stroke="black" stroke-width="2px" fill-opacity="0.0" />
  </g>
</svg>
{% endmacro %}

{% macro draw_delete() %}
<svg width="22" height="22" viewBox="0 0 22 22">
  <line x1="3" y1="3" x2="19" y2="19" />
  <line x1="19" y1="3" x2="3" y2="19" />
</svg>
{% endmacro %}

{% macro draw_tomorrow() %}
<svg width="22" height="22" viewBox="0 0 22 22">
  <line x1="3" y1="10" x2="18" y2="10" />
  <line x1="10" y1="3" x2="19" y2="10" />
  <line x1="10" y1="18" x2="19" y2="10" />
</svg>
{% endmacro %}

<body>

{{ date_nav() }}
<div id="date_nav_placeholder"></div>

<div id="list_container" width="400">
{% for task in tasks %}
{{ draw_task(task) }}
{% endfor %}
</div>

<div id="input_form">
  <form autocomplete="off">
    <svg id="new_task_diamond" class="touchable" width="28" height="28">
      <g transform="translate(0) rotate(45 12 16)">
        <rect class="touchable" x="3" y="4" rx="1" ry="1" stroke-width="2px" width="18" height="18"   />
      </g>
    </svg>
    <input id="entry_box" type="text" name="description" autofocus="autofocus" value="{{ entered_text }}">
    <input id="date_due_box" hidden="hidden" type="text" name="date_due" value="{{ date }}">
  </form>
</div>

<div class="tt_logo" align="right">
  <svg id="logo" class="started" width="28" height="28" viewBox="0 0 28 28">
    <g transform="translate(0) rotate(45 16 16)">
      <rect x="8" y="8" rx="1" ry="1" width="16" height="16" stroke="gray" stroke-width="2px" />
    </g>
    <line id="logoslash" x1="27" y1="5" x2="5" y2="27" />
  </svg><span> tinytask</span>
</div>
<div class="logomenu">
<a href="/info/">about</a><br><a href="/updates/">updates</a><br><a href="/log out/">log out</a><p id="scr_width">0</p><br><a id="import_yesterday" href="#">import yesterday</a>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>

// Debug
function get_doc_width() {
  $("p#scr_width").text($(document).width());
}

// Helpers
function insert_task() {
  entered_text = $("#entry_box").val();
  if (entered_text !== "") {
    data = {"description": entered_text,
    "date_due": $("#date_due_box").val()};
    $.post("/tasklist/insert/", data, function() {
      location.reload();
    });
  }
}

function set_task(task, container) {
  console.log("Task " + task.task_key + " set to: " + task.status);
  container.attr("class", task.status);
}

function update_menu_undo(container) {
  undo_span = container.parent().find($("span#un-do"));
  if (container.attr("class")==="notdone") {
      undo_span.hide();
      undo_span.next().hide();
  } else {
      undo_span.show();
      undo_span.next().show();
  }
}

function update_menu_tomorrow(container) {
  tomorrow_span = container.parent().find($("span#move-tomorrow"));
  if (container.attr("class")==="done") {
    tomorrow_span.hide();
  } else {
    tomorrow_span.show();
  }
}

function go_tomorrow() {
  window.location.href = "/date/{{ get_days(date, 1) }}/";
}

function go_yesterday() {
  window.location.href = "/date/{{ get_days(date, -1) }}/";
}

function get_todays_date() {
  today = new Date();
  year = today.toLocaleDateString("en-US", {year: "numeric"});
  month = today.toLocaleDateString("en-US", {month: "2-digit"});
  day = today.toLocaleDateString("en-US", {day: "2-digit"});
  return year + month + day;
}

function set_logo_tense() {
  list_date = "{{ date }}";
  today = get_todays_date();
  tense = "present";
  if (list_date > today) { tense = "future"; }
  if (list_date < today) { tense = "past"; }
  $("g#date_diamond").attr("class", tense);
}

function set_date_position() {
  date_width = $("div#date_test_width").width() + 33;
  position = 190 - (date_width / 2);
  $("g#date_display").attr("transform", "translate(" + position + ", 0)");
  $("div#date_nav_placeholder").hide();
  $("div#date_nav").show();
}

function user_is_typing() {
  is_typing = true;
  entry_box = $("#entry_box");
  if (!entry_box.is(":focus")) {
    is_typing = false;
  } else if (entry_box.val()==="") {
    is_typing = false;
  }
  return is_typing;
}

function check_if_refresh_needed(today, page_load_time) {
  data = {
    "date": today,
    "page_load_time": page_load_time
  };
  $.get("/tasklist/need_to_refresh", data, function(result) {
    if (result==="true") {
      window.location.href = "/date/" + {{ date }} + "/";
    }
  });
}

// jQuery magic
$(document).ready(function() {

  get_doc_width();
  set_date_position();
  set_logo_tense();
  check_if_refresh_needed({{ date }}, {{ time_loaded }});

  $("svg#task_diamond").each(function(i) {
    update_menu_tomorrow($(this));
    update_menu_undo($(this));
  });

  // Open/close task menu
  $("span.task_text").click(function() {
    task_menu = $(this).next();
    if (task_menu.is(":visible")) {
      task_menu.hide(200);
    } else {
      $("div.taskmenu").hide(200);
      task_menu.show(200);
    }
  });

  // Open/close logo menu
  $("div.tt_logo").click(function() {
    logo_menu = $(this).next();
    if (logo_menu.is(":visible")) {
      logo_menu.hide(200);
    } else {
      logo_menu.show(200);
    }
  });

  // Advance task status
  $("svg#task_diamond").click(function() {
    diamond = $(this);
    if (diamond.hasClass("done")) {
      return;
    }
    if (diamond.hasClass("started")) {
      diamond.attr("class", "done");
      update_menu_tomorrow(diamond);
    }
    if (diamond.hasClass("notdone")) {
      diamond.attr("class", "started");
      update_menu_undo(diamond);
    }
    data = {
      "date_due": diamond.parent().attr("date"),
      "task_key": diamond.parent().attr("key")
    };
    $.post("/tasklist/advance/", data, function(response) {
      set_task(response, diamond);
    }, "json");
  });

  // Un-do task, reset to "notdone" status
  $("span#un-do").click(function() {
    un_do_span = $(this);
    diamond = un_do_span.parent().parent().children().first();
    un_do_span.parent().hide(200);
    data = {
      "date_due": un_do_span.parent().parent().attr("date"),
      "task_key": un_do_span.parent().parent().attr("key"),
      "status": "notdone"
    };
    set_task(data, diamond);
    un_do_span.parent().hide(200);
    $.post("/tasklist/undo/", data);
    update_menu_undo(diamond);
    update_menu_tomorrow(diamond);
  });

  // Delete task
  $("span#delete").click(function() {
    delete_span = $(this);
    data = {
      "date_due": delete_span.parent().parent().attr("date"),
      "task_key": delete_span.parent().parent().attr("key")
    };
    delete_span.parent().parent().hide(200);
    $.post("/tasklist/delete/", data, function() {
      window.location.href = "/date/" + data["date_due"] + "/";
    });
  });

  // Move it to tomorrow
  $("span#move-tomorrow").click(function() {
    move_span = $(this);
    data = {
      "date_due": move_span.parent().parent().attr("date"),
      "task_key": move_span.parent().parent().attr("key"),
      "x_days": 1
    };
    move_span.parent().parent().hide(200);
    $.post("/tasklist/moveto/", data, function() {
      window.location.href = "/date/" + data["date_due"] + "/";
    });
  });

  // Date navigation
  $("rect#yesterday_button").click(function() {
    go_yesterday();
  });

  $("rect#tomorrow_button").click(function() {
    go_tomorrow();
  });

  $("#new_task_diamond").click(function() {
    insert_task();
  });
});

$(document).keyup(function(e) {
  if ($("#entry_box").is(":focus")) {
    if (e.keyCode === 13) {
      insert_task();
    }
  }
  if (user_is_typing()) {
    return;
  }
  if (e.keyCode === 27) {
    $("div.taskmenu").hide(200);
  }
  if (e.keyCode === 37) {
    go_yesterday();
  }
  if (e.keyCode === 39) {
    go_tomorrow();
  }
});

window.onfocus = function() {
  check_if_refresh_needed({{ date }}, {{ time_loaded }});
};
</script>
</body>
</html>
