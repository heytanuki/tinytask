<head>
<!-- <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}"> -->
<link rel="icon" type="image/png" href="/static/favicon.png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
div.logo {
  font-family: Helvetica, sans-serif;
  font-weight: normal;
  stroke: black;
  margin-bottom: 20px;
}
input {
  font-family: sans-serif;
  font-weight: normal;
  font-size: 22pt;

}
div#input_form {
  margin-top: 5px;
}
div.tinylogo {
  padding-top: 20px;
  color: gray;
}
div.task_container {
  /*width: 400px;*/
  padding-bottom: 5px;
}
div.hidden {
  display: none;
}
span.task_text {
  padding-left: 5px;
}
div.taskmenu {
  display: none;

  border-width: 2px 0px 0px 0px;
  border-style: solid;
  border-color: darkgray;
  background-color: rgb(245, 245, 245);

  padding-left: 33px;
  margin-top: 5px;
  vertical-align: top;
}
body {
  font-family: sans-serif;
  font-weight: normal;
  font-size: 22pt;
}
a {
  text-decoration: none;
  color: black;
}
svg {
  vertical-align: -1px;
}
svg.date_arrow {
  vertical-align: -3px;
}
svg.notdone > line#forwardslash {
  stroke-width: 0px;
}
svg.notdone > line#backslash {
  stroke-width: 0px;
}
svg.started > line#forwardslash {
  stroke-width: 2px;
}
svg.started > line#backslash {
  stroke-width: 0px;
}
svg.done > line#forwardslash {
  stroke-width: 2px;
}
svg.done > line#backslash {
  stroke-width: 2px;
}
line {
  stroke-linecap: round;
  stroke-width: 2px;
  stroke: black;
}
div.tinylogo > svg > line {
  stroke: gray;
}
</style>
</head>

{% macro date_nav() %}
<a href="/{{ get_days(date, -1) }}">
  <svg class="date_arrow" width="28" height="28" viewBox="0 0 28 28">
    <line x1="14" y1="2" x2="2" y2="14" />
    <line x1="14" y1="26" x2="2" y2="14" />
  </svg>
</a>

<svg id="logo" class="{{ date_status }}" width="28" height="28" viewBox="0 0 28 28">
  <g transform="translate(0) rotate(45 16 16)"><!-- second 2 rotate args: rect x + width/2 -->
    <rect x="8" y="8" rx="1" ry="1" width="16" height="16" stroke-width="2" fill="white"  />
  </g>
 <line id="forwardslash" stroke-width="0" x1="27" y1="5" x2="5" y2="27" />
 <line id="backslash" stroke-width="0" x1="5" y1="5" x2="27" y2="27" />
</svg>

{{ get_readable_date(date) }}
<a href="/{{ get_days(date, 1) }}">
  <svg class="date_arrow" width="28" height="28" viewBox="0 0 28 28">
    <line x1="14" y1="2" x2="26" y2="14" />
    <line x1="14" y1="26" x2="26" y2="14" />
  </svg>
</a>
{% endmacro %}

{% macro draw_task(task) %}
<div class="task_container" date="{{ date }}"" key="{{ task['task_key'] }}">
  <svg id="taskdiamond" class="{{ task['status'] }}" width="28" height="28" viewBox="0 0 28 28">
    <g transform="translate(0) rotate(45 16 16)"><!-- second 2 rotate args: rect x + width/2 -->
      <rect x="8" y="8" rx="1" ry="1" width="16" height="16" stroke="black" stroke-width="2" fill="white"  />
    </g>
    <line id="forwardslash" stroke="black" stroke-width="0" x1="27" y1="5" x2="5" y2="27" />
    <line id="backslash" stroke="black" stroke-width="0" x1="5" y1="5" x2="27" y2="27" />
  </svg>
  <span class="task_text">{{ task['description'] }}</span>
  <div class="taskmenu">
    
    <span id="un-do">{{ draw_undo() }}un-do</span><br>

    <span id="delete">{{ draw_delete() }}delete</span>

    <span id="move-tomorrow"><br>{{ draw_tomorrow() }}tomorrow</span>

  </div>
</div>
{% endmacro %}

{% macro draw_undo() %}
<svg width="22" height="22" viewBox="0 0 22 22">
  <g transform="translate(0) rotate(45 15 10)"><!-- second 2 rotate args: rect x + width/2 -->
    <rect x="6" y="6" rx="1" ry="1" width="14" height="14" stroke="black" stroke-width="2" fill-opacity="0.0" />
  </g>
</svg>
{% endmacro %}

{% macro draw_delete() %}
<svg width="22" height="22" viewBox="0 0 22 22">
  <line x1="3" y1="3" x2="19" y2="19" />
  <line x1="19" y1="3" x2="3" y2="19" />
</svg>
{% endmacro %}

{% macro draw_tomorrow() %}
<svg width="22" height="22" viewBox="0 0 22 22">
  <line x1="3" y1="10" x2="19" y2="10" />
  <line x1="10" y1="3" x2="19" y2="10" />
  <line x1="10" y1="18" x2="19" y2="10" />
</svg>
{% endmacro %}

<body>
<div class="logo">
{{ date_nav() }} 
</div>



<!-- task list -->
{% for task in tasks %}
{{ draw_task(task) }}
{% endfor %}

<!-- proto entry form -->
<div id="input_form" date="{{ date }}">
<form action="/insert" method="post" autocomplete="off">
    <input type="text" name="description" autofocus="autofocus">
    <input hidden="hidden" type="text" name="date_due" value="{{ date }}">
    <input hidden="hidden" type="submit" value="Submit">
</form>
</div>

<!-- delete this -->
<div class="hidden" id="tools">
  <p id="flask-date">{{ date }}</p>
  <p><a href="reset/{{ date }}">reset</a></p>
</div>

<div class="tinylogo" align="right">
  <svg id="logo" class="started" width="28" height="28" viewBox="0 0 28 28">
    <g transform="translate(0) rotate(45 16 16)"><!-- second 2 rotate args: rect x + width/2 -->
      <rect x="8" y="8" rx="1" ry="1" width="16" height="16" stroke="gray" stroke-width="2" fill="white"  />
    </g>
    <line id="forwardslash" stroke-width="2" stroke="gray" x1="27" y1="5" x2="5" y2="27" />
  </svg><span> tinytask</span>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
function set_task(task, container) {
  console.log("Task " + task["task_key"] + " set to: " + task["status"]);
  container.attr("class", task["status"]);
};

function update_logo() {
  count = 0;
  done_count = 0;
  $("svg#taskdiamond").each(function(i) {
    if ($(this).attr("class")==="done") { done_count += 1; };
    count += 1;
  });
  if (count===done_count) { $("svg#logo").attr("class", "done"); };
};

function update_menu_undo(container) {
  undo_span = container.parent().find($("span#un-do"));
  if (container.attr("class")==="notdone") {
      undo_span.hide();
      undo_span.next().hide();
  } else {
      undo_span.show();
      undo_span.next().show();
  };
};

function update_menu_tomorrow(container) {
  tomorrow_span = container.parent().find($("span#move-tomorrow"));
  if (container.attr("class")==="done") {
    tomorrow_span.hide();
  } else {
    tomorrow_span.show();
  }
};

$(document).ready(function() {

  $("svg#taskdiamond").each(function(i) {
    update_menu_tomorrow($(this));
    update_menu_undo($(this));
  });
  
// Advance task status
  $("svg#taskdiamond").click(function() {
    if ($(this).attr("class")==="done") {
      return;
    };
    if ($(this).attr("class")==="started") {
      $(this).attr("class", "done");
      update_logo();
      update_menu_tomorrow($(this));
    };
    if ($(this).attr("class")==="notdone") {
      $(this).attr("class", "started");
      update_menu_undo($(this));
    };
    data = {
      "date_due": $(this).parent().attr("date"),
      "task_key": $(this).parent().attr("key")
    };
    $.post("tasklist/advance", data, function(response) {
      set_task(response, $(this));
    }, "json");
  });

// Open/close task menu
  $("span.task_text").click(function() {
    if ($(this).next().is(":visible")) {
      $(this).next().hide(200);
    } else {
      $("div.taskmenu").hide(200);
      $(this).next().show(200);
    }
  });

// Un-do task, reset to "notdone" status
  $("span#un-do").click(function() {
    diamond = $(this).parent().parent().children().first();
    $(this).parent().hide(200);
    data = {
      "date_due": $(this).parent().parent().attr("date"),
      "task_key": $(this).parent().parent().attr("key"),
      "status": "notdone"
    };
    set_task(data, diamond);
    $(this).parent().hide(200);
    $.post("tasklist/undo", data);
    $("svg#logo").attr("class", "started");
    update_menu_undo(diamond);
    update_menu_tomorrow(diamond);
  });

// Delete task
  $("span#delete").click(function() {
    data = {
      "date_due": $(this).parent().parent().attr("date"),
      "task_key": $(this).parent().parent().attr("key")
    };
    $(this).parent().parent().hide(200);
    $.post("tasklist/delete", data, function() {
      window.location.href = "/" + data["date_due"];
    });
  });

// Move it to tomorrow
  $("span#move-tomorrow").click(function() {
    data = {
      "date_due": $(this).parent().parent().attr("date"),
      "task_key": $(this).parent().parent().attr("key"),
      "x_days": 1
    };
    $(this).parent().parent().hide(200);
    $.post("tasklist/moveto", data, function() {
      window.location.href = "/" + data["date_due"];
    });
  });

// Home
  $("div.logo").click(function() {
    window.location.href = "/";
  });
});

$(document).keyup(function(e) {
  if (e.keyCode===27){
    $("div.taskmenu").hide(200);
  };
});

// window.onfocus = function() {location.reload(true);};
</script>
</body>